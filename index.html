<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Five Sine Waves</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 16px; }
    .row { display: flex; align-items: center; gap: 12px; margin: 10px 0; }
    .row label { width: 70px; }
    .freq { width: 90px; font-variant-numeric: tabular-nums; }
    input[type="range"] { width: min(520px, 60vw); }
    button { padding: 6px 10px; }
    .hint { opacity: 0.8; margin: 8px 0 14px; }
  </style>
</head>
<body>
  <h1>Play with five pitches</h1>

  <button id="enableBtn">Enable Audio</button>
  <div class="hint">
    Tap <b>Enable Audio</b> once (especially on iPhone/Safari). Then use Start/Stop.
  </div>

  <div id="controls"></div>

  <script>
    // ---------- UI FIRST (no audio touched yet) ----------
    const controls = document.getElementById("controls");

    for (let i = 0; i < 5; i++) {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <label>Pitch ${i + 1}</label>
        <input type="range" min="50" max="1000" step="1" value="440">
        <span class="freq">440 Hz</span>
        <button>Start</button>
      `;
      controls.appendChild(row);
    }

    // ---------- AUDIO LAZY-INIT ----------
    let audioContext = null;
    let masterGain = null;

    const MASTER_GAIN_VALUE = 0.25;  // overall
    const WAVE_ON_GAIN_VALUE = 0.20; // per wave

    function ensureAudioContext() {
      if (!audioContext) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) throw new Error("Web Audio API not supported in this browser.");
        audioContext = new Ctx();

        masterGain = audioContext.createGain();
        masterGain.gain.value = MASTER_GAIN_VALUE;
        masterGain.connect(audioContext.destination);
      }
    }

    async function enableAudio() {
      ensureAudioContext();
      if (audioContext.state !== "running") {
        await audioContext.resume();
      }
    }

    document.getElementById("enableBtn").addEventListener("click", async () => {
      try {
        await enableAudio();
        document.getElementById("enableBtn").textContent = "Audio Enabled";
      } catch (err) {
        console.error(err);
        alert("Could not enable audio. Check Silent Mode / permissions / browser support.");
      }
    });

    // one wave state per row
    const waveStates = Array.from({ length: 5 }, () => ({
      osc: null,
      gain: null,
      isPlaying: false,
      freq: 440
    }));

    // Wire up each row
    document.querySelectorAll("#controls .row").forEach((row, i) => {
      const slider = row.querySelector('input[type="range"]');
      const freqSpan = row.querySelector(".freq");
      const btn = row.querySelector("button");
      const state = waveStates[i];

      slider.addEventListener("input", () => {
        state.freq = Number(slider.value);
        freqSpan.textContent = `${state.freq} Hz`;
        // If oscillator exists, update it live
        if (state.osc && audioContext) {
          state.osc.frequency.setValueAtTime(state.freq, audioContext.currentTime);
        }
      });

      btn.addEventListener("click", async () => {
        try {
          // Always ensure audio from a gesture
          await enableAudio();

          if (!state.osc) {
            // Create nodes only when first started (gesture-safe)
            state.osc = audioContext.createOscillator();
            state.osc.type = "sine";
            state.osc.frequency.value = state.freq;

            state.gain = audioContext.createGain();
            state.gain.gain.value = 0;

            state.osc.connect(state.gain).connect(masterGain);
            state.osc.start();
          }

          state.isPlaying = !state.isPlaying;

          const now = audioContext.currentTime;
          state.gain.gain.cancelScheduledValues(now);
          state.gain.gain.setValueAtTime(state.gain.gain.value, now);
          state.gain.gain.linearRampToValueAtTime(
            state.isPlaying ? WAVE_ON_GAIN_VALUE : 0,
            now + 0.02
          );

          btn.textContent = state.isPlaying ? "Stop" : "Start";
        } catch (err) {
          console.error(err);
          alert("Audio could not start. Try clicking Enable Audio first.");
        }
      });
    });
  </script>
      <img
    src="harmonic%20series.jpg"
    alt="Harmonic series"
    style="display: block; margin: 40px auto 0; max-width: 100%; height: auto;"
  >

</body>
</html>
