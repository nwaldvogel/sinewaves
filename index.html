<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Two Sine Waves (Shared Scope)</title>
  <style>
    :root { --w: 900px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color:#111; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .wrap { max-width: var(--w); }

    .topbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 8px 0 14px; }
    button { padding: 8px 12px; border-radius: 10px; border: 1px solid #ccc; background:#fff; cursor:pointer; }
    button.primary { border-color:#999; font-weight:600; }
    button:active { transform: translateY(1px); }
    .state { font-size: 13px; color:#333; }
    .hint { font-size: 13px; color:#555; }

    canvas { width: 100%; height: 220px; border-radius: 12px; border: 1px solid #e3e3e3; background:#fafafa; display:block; }

    .panels { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .panel { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
    .panel h2 { font-size: 15px; margin: 0 0 8px; }

    .row { display:grid; grid-template-columns: 110px 1fr; gap: 10px; align-items:center; margin: 10px 0; }
    .controls { display:grid; grid-template-columns: 120px 1fr 90px; gap: 10px; align-items:center; }
    input[type="range"] { width: 100%; }
    .value { font-variant-numeric: tabular-nums; text-align:right; }

    .panel.red { --c: #d11; --cSoft: rgba(209,17,17,0.08); --cBorder: rgba(209,17,17,0.45); }
    .panel.blue{ --c: #06c; --cSoft: rgba(0,102,204,0.08); --cBorder: rgba(0,102,204,0.45); }

    .panel.red, .panel.blue { border-color: var(--cBorder); background: linear-gradient(0deg, #fff, var(--cSoft)); }
    .panel .label { color: var(--c); font-weight: 600; }
    .panel button { border-color: var(--cBorder); }
    .panel button:hover { background: var(--cSoft); }
    .panel .toggle { font-weight: 650; color: var(--c); }
    .panel .status { color: var(--c); }
    .panel input[type="range"] { accent-color: var(--c); }

    @media (max-width: 820px) {
      .panels { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Two Sine Waves (One Scope, Trigger-Stable)</h1>

    <div class="topbar">
      <button id="enableAudio" class="primary">Enable Audio</button>
      <div class="state">Audio: <span id="audioState">not created</span></div>
      <div class="hint">Click <b>Enable Audio</b>, then start either wave.</div>
    </div>

    <canvas id="scope" width="900" height="260"></canvas>

    <div class="panels">
      <div class="panel red" id="waveA">
        <h2><span class="label">Wave A</span></h2>

        <div class="row">
          <div class="label">Controls</div>
          <div class="controls">
            <button class="toggle">Start</button>
            <div></div>
            <div class="value status">Stopped</div>
          </div>
        </div>

        <div class="row">
          <div class="label">Pitch</div>
          <div class="controls">
            <input class="freq" type="range" min="40" max="2000" step="1" value="440" />
            <div class="value"><span class="freqVal">440</span> Hz</div>
            <button class="preset" data-hz="440">A4</button>
          </div>
        </div>

        <div class="row">
          <div class="label">Amp</div>
          <div class="controls">
            <input class="amp" type="range" min="0" max="1" step="0.001" value="0.25" />
            <div class="value"><span class="ampVal">0.250</span></div>
            <button class="mute">Mute</button>
          </div>
        </div>
      </div>

      <div class="panel blue" id="waveB">
        <h2><span class="label">Wave B</span></h2>

        <div class="row">
          <div class="label">Controls</div>
          <div class="controls">
            <button class="toggle">Start</button>
            <div></div>
            <div class="value status">Stopped</div>
          </div>
        </div>

        <div class="row">
          <div class="label">Pitch</div>
          <div class="controls">
            <input class="freq" type="range" min="40" max="2000" step="1" value="660" />
            <div class="value"><span class="freqVal">660</span> Hz</div>
            <button class="preset" data-hz="660">E5</button>
          </div>
        </div>

        <div class="row">
          <div class="label">Amp</div>
          <div class="controls">
            <input class="amp" type="range" min="0" max="1" step="0.001" value="0.25" />
            <div class="value"><span class="ampVal">0.250</span></div>
            <button class="mute">Mute</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // -------- Shared AudioContext + master output --------
  let audioCtx = null;
  let masterGain = null;

  const audioStateEl = document.getElementById("audioState");
  const enableBtn = document.getElementById("enableAudio");

  function setAudioStateText() {
    audioStateEl.textContent = audioCtx ? audioCtx.state : "not created";
  }

  function ensureAudioGraph() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.9;
      masterGain.connect(audioCtx.destination);

      audioCtx.onstatechange = setAudioStateText;
      setAudioStateText();
    }
    return audioCtx;
  }

  async function unlockAudio() {
    const ac = ensureAudioGraph();

    if (ac.state !== "running") {
      try { await ac.resume(); } catch (e) { console.warn("resume failed", e); }
    }

    // Safari/iOS "wake tick"
    try {
      const o = ac.createOscillator();
      const g = ac.createGain();
      g.gain.value = 0.00001;
      o.connect(g).connect(masterGain);
      o.start();
      o.stop(ac.currentTime + 0.02);
    } catch (_) {}

    setAudioStateText();
    enableBtn.textContent = (audioCtx.state === "running") ? "Audio Enabled" : "Enable Audio";
  }

  enableBtn.addEventListener("click", unlockAudio);
  window.addEventListener("touchend", () => {
    if (!audioCtx || audioCtx.state !== "running") unlockAudio();
  }, { passive: true });
  window.addEventListener("keydown", () => {
    if (!audioCtx || audioCtx.state !== "running") unlockAudio();
  });

  // -------- Shared scope (draw both, with trigger) --------
  const scope = document.getElementById("scope");
  const g2 = scope.getContext("2d", { alpha: false });

  // Trigger settings:
  const TRIGGER_LEVEL = 128;   // 0..255 (128 ~ "zero" for time-domain)
  const TRIGGER_HYST  = 2;     // hysteresis band to avoid noise-triggering
  const MIN_SLOPE     = 0;     // increase to require a steeper rise (0 is fine for pure sines)

  function findRisingTriggerIndex(buf) {
    // Find index i where we cross from below (level - hyst) to above (level + hyst).
    const low  = TRIGGER_LEVEL - TRIGGER_HYST;
    const high = TRIGGER_LEVEL + TRIGGER_HYST;

    // Start a little in to avoid edge weirdness
    for (let i = 1; i < buf.length; i++) {
      const a = buf[i - 1];
      const b = buf[i];
      if (a <= low && b >= high) {
        if (MIN_SLOPE <= 0 || (b - a) >= MIN_SLOPE) return i;
      }
    }
    return 0;
  }

  function drawTriggeredWave(data, strokeStyle) {
    const W = scope.width, H = scope.height;

    const start = findRisingTriggerIndex(data);
    const N = data.length;

    g2.strokeStyle = strokeStyle;
    g2.lineWidth = 2;
    g2.beginPath();

    // Sample mapping: walk across the canvas, pulling samples from data starting at trigger index.
    // Step can be >1 if N is much larger than width, but this keeps it simple.
    const step = N / W;

    for (let x = 0; x < W; x++) {
      const idx = (start + Math.floor(x * step)) % N;
      const v = data[idx] / 255;   // 0..1
      const y = v * H;             // 0..H
      if (x === 0) g2.moveTo(x, y);
      else g2.lineTo(x, y);
    }
    g2.stroke();
  }

  function drawSharedScope(aCtrl, bCtrl) {
    const W = scope.width, H = scope.height;
    const mid = H / 2;

    function draw() {
      requestAnimationFrame(draw);

      // background
      g2.fillStyle = "#fafafa";
      g2.fillRect(0, 0, W, H);

      // grid
      g2.strokeStyle = "#eee";
      g2.lineWidth = 1;
      g2.beginPath();
      const cols = 10;
      for (let i = 1; i < cols; i++) {
        const x = (W * i) / cols;
        g2.moveTo(x, 0);
        g2.lineTo(x, H);
      }
      g2.stroke();

      // midline
      g2.strokeStyle = "#ddd";
      g2.beginPath();
      g2.moveTo(0, mid);
      g2.lineTo(W, mid);
      g2.stroke();

      if (!aCtrl.analyser && !bCtrl.analyser) {
        g2.fillStyle = "#777";
        g2.font = "14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        g2.fillText("Waveforms appear here when playingâ€¦", 12, 22);
        return;
      }

      // Acquire buffers and draw each wave, triggered
      if (aCtrl.analyser) {
        aCtrl.analyser.getByteTimeDomainData(aCtrl.data);
        drawTriggeredWave(aCtrl.data, "#d11");
      }
      if (bCtrl.analyser) {
        bCtrl.analyser.getByteTimeDomainData(bCtrl.data);
        drawTriggeredWave(bCtrl.data, "#06c");
      }
    }
    draw();
  }

  // -------- Per-wave controller (independent) --------
  const FFT_SIZE = 8192; // bigger = slower-looking and more stable

  function createWaveController(rootEl) {
    const toggleBtn = rootEl.querySelector(".toggle");
    const muteBtn   = rootEl.querySelector(".mute");
    const presetBtn = rootEl.querySelector(".preset");
    const statusEl  = rootEl.querySelector(".status");

    const freqSlider = rootEl.querySelector(".freq");
    const ampSlider  = rootEl.querySelector(".amp");
    const freqValEl  = rootEl.querySelector(".freqVal");
    const ampValEl   = rootEl.querySelector(".ampVal");

    let osc = null;
    let gain = null;
    let analyser = null;

    let running = false;
    let muted = false;
    let lastAmpBeforeMute = parseFloat(ampSlider.value);

    const data = new Uint8Array(FFT_SIZE);

    function updateLabels() {
      freqValEl.textContent = String(freqSlider.value);
      ampValEl.textContent = Number(ampSlider.value).toFixed(3);
    }
    function setStatus() {
      statusEl.textContent = running ? "Playing" : "Stopped";
      toggleBtn.textContent = running ? "Stop" : "Start";
    }

    function ensureNodes() {
      if (osc) return;
      const ac = ensureAudioGraph();

      osc = ac.createOscillator();
      osc.type = "sine";
      osc.frequency.value = parseFloat(freqSlider.value);

      gain = ac.createGain();
      gain.gain.value = muted ? 0 : parseFloat(ampSlider.value);

      analyser = ac.createAnalyser();
      analyser.fftSize = FFT_SIZE;
      analyser.smoothingTimeConstant = 0.85;

      osc.connect(gain);
      gain.connect(analyser);
      analyser.connect(masterGain);
    }

    async function start() {
      await unlockAudio();
      ensureNodes();
      if (running) return;

      try {
        osc.start();
        running = true;
        setStatus();
      } catch (e) {
        console.warn("osc.start failed; rebuilding", e);
        stop(true);
        ensureNodes();
        try {
          osc.start();
          running = true;
          setStatus();
        } catch (e2) {
          console.warn("osc.start failed again", e2);
        }
      }
    }

    function stop(hard=false) {
      if (!osc && !hard) return;

      if (running && osc) { try { osc.stop(); } catch (_) {} }
      try { osc && osc.disconnect(); } catch (_) {}
      try { gain && gain.disconnect(); } catch (_) {}
      try { analyser && analyser.disconnect(); } catch (_) {}

      osc = null; gain = null; analyser = null;
      running = false;
      if (!hard) setStatus();
    }

    function setFreq(hz) {
      hz = Math.max(1, Number(hz) || 0);
      if (osc) {
        const ac = ensureAudioGraph();
        osc.frequency.setTargetAtTime(hz, ac.currentTime, 0.01);
      }
    }

    function setAmp(a) {
      a = Math.min(1, Math.max(0, Number(a) || 0));
      if (gain) {
        const ac = ensureAudioGraph();
        gain.gain.setTargetAtTime(a, ac.currentTime, 0.01);
      }
    }

    updateLabels();
    setStatus();

    toggleBtn.addEventListener("click", () => { running ? stop() : start(); });

    freqSlider.addEventListener("input", () => {
      updateLabels();
      setFreq(freqSlider.value);
    });

    ampSlider.addEventListener("input", () => {
      updateLabels();
      if (!muted) lastAmpBeforeMute = parseFloat(ampSlider.value);
      setAmp(muted ? 0 : ampSlider.value);
    });

    presetBtn.addEventListener("click", () => {
      const hz = Number(presetBtn.dataset.hz);
      freqSlider.value = String(hz);
      updateLabels();
      setFreq(hz);
    });

    muteBtn.addEventListener("click", () => {
      muted = !muted;
      muteBtn.textContent = muted ? "Unmute" : "Mute";
      if (muted) {
        lastAmpBeforeMute = parseFloat(ampSlider.value);
        setAmp(0);
      } else {
        ampSlider.value = String(lastAmpBeforeMute);
        updateLabels();
        setAmp(lastAmpBeforeMute);
      }
    });

    return {
      get analyser() { return analyser; },
      data
    };
  }

  const ctrlA = createWaveController(document.getElementById("waveA"));
  const ctrlB = createWaveController(document.getElementById("waveB"));
  drawSharedScope(ctrlA, ctrlB);

  setAudioStateText();
})();
</script>
</body>
</html>
